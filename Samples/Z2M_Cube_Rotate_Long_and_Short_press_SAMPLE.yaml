# This is an action statement that you can use in your Blueprint Automation 
#  to call a script (below) to dim a light when rotating the cube.
#
# In the blueprint automation:
#   https://my.home-assistant.io/redirect/automations/

rotate_cw_face_3:
  - service: cube_long_cw_toggle
    data:
      angle: '{{ trigger.payload_json.action_angle | float(0.0)}}'
      entity: light.livingroomlight
  - service: cube_short_cw_toggle
    data:
      angle: '{{ trigger.payload_json.action_angle | float(0.0)}}'
      entity: light.livingroomlight

# These are the standalone scripts that are 'called' from the Script 
#  calling yaml shown above. 
# If you don't need all of these only install the ones you will use.
#
# NOTE: More information on setting this up can be found in this thread:
#   https://community.home-assistant.io/t/zigbee2mqtt-aqara-magic-cube-t1-pro-ctp-r01-xiaomi-lumi-cagl02/525111/27
#
# This uses 
#   https://www.home-assistant.io/integrations/homeassistant#service-homeassistanttoggle)
#  so it can toggle anything that that service can handle.
# Changing it to homeassistant.turn_on or homeassistant.turn_off would change the behavior 
#  slightly if this fits your needs better.

script:
  cube_short_cw_toggle:
    description: CW Short Press Toggle
    fields:
      angle:
        name: Angle to represent new switch function
        description:
          This is the new angle to be used in the calculation for switch function
        required: true
        example: "120.7"
        selector:
          number:
            min: 0
            max: 360
            step: 0.1
            mode: box
      entity:
        name: Entity to control
        description: Add the entity you want to control here
        required: true
        selector:
          entity:
            multiple: false
    sequence:
      - condition: template
        value_template: '{{ angle > 0 <= 100 }}'
      - service: homeassistant.toggle
        target:
          entity_id: '{{ entity }}'
  cube_long_cw_toggle:
    description: CW Long Press Toggle
    fields:
      angle:
        name: Angle to represent new switch function
        description:
          This is the new angle to be used in the calculation for switch function
        required: true
        example: "120.7"
        selector:
          number:
            min: 0
            max: 360
            step: 0.1
            mode: box
      entity:
        name: Entity to control
        description: Add the entity you want to control here
        required: true
        selector:
          entity:
            multiple: false
    sequence:
      - condition: template
        value_template: '{{ angle > 100 }}'
      - service: homeassistant.toggle
        target:
          entity_id: '{{ entity }}'

  cube_short_ccw_toggle:
    description: CCW Short Press Toggle
    fields:
      angle:
        name: Angle to represent new switch function
        description:
          This is the new angle to be used in the calculation for switch function
        required: true
        example: "-120.7"
        selector:
          number:
            min: -360
            max: 0
            step: 0.1
            mode: box
      entity:
        name: Entity to control
        description: Add the entity you want to control here
        required: true
        selector:
          entity:
            multiple: false
    sequence:
      - condition: template
        value_template: '{{ angle < 0 >= -100 }}'
      - service: homeassistant.toggle
        target:
          entity_id: '{{ entity }}'
  cube_long_ccw_toggle:
    description: CCW Long Press Toggle
    fields:
      angle:
        name: Angle to represent new switch function
        description:
          This is the new angle to be used in the calculation for switch function
        required: true
        example: "-120.7"
        selector:
          number:
            min: -360
            max: 0
            step: 0.1
            mode: box
      entity:
        name: Entity to control
        description: Add the entity you want to control here
        required: true
        selector:
          entity:
            multiple: false
    sequence:
      - condition: template
        value_template: '{{ angle < -100 }}'
      - service: homeassistant.toggle
        target:
          entity_id: '{{ entity }}'
